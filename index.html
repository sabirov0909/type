<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TypeRacer Pro Elite</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #121212;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            color: #fff;
        }
        .container { max-width: 650px; width: 100%; }
        .game-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        input {
            background: #fff;
            border: none;
            padding: 15px;
            border-radius: 12px;
            color: #111;
            font-size: 18px;
            width: 100%;
            margin-top: 10px;
        }
        .text-display {
            font-size: 1.4rem;
            line-height: 1.6;
            text-align: left;
            letter-spacing: 0.5px;
            color: #888;
            font-family: 'Courier New', monospace;
            word-break: break-word;
        }
        .correct { color: #4ade80; }
        .wrong { background: #f87171; color: #fff; border-radius: 2px; }
        .current-char { border-left: 2px solid #fdbb2d; animation: cursor 0.8s infinite; }
        @keyframes cursor { 50% { border-color: transparent; } }

        .race-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; position: relative; margin: 30px 0 15px; }
        .race-car { position: absolute; transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 24px; top: -30px; margin-left: -12px; }

        button { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; width: 100%; transition: 0.2s; }
        .btn-create { background: #4ade80; }
        .btn-join { background: #60a5fa; }
        .btn-start { background: #fdbb2d; color: #000; font-size: 18px; margin-top: 10px; }

        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 12px; color: #aaa; text-transform: uppercase; }
        .stat-val { display: block; font-size: 20px; font-weight: bold; color: #fdbb2d; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; margin: 20px 0;">üèéÔ∏è Typeracer Elite</h2>

    <div class="game-card" id="lobby">
        <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–¥–ª—è –≤—Ö–æ–¥–∞)">
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn-create" onclick="createRoom()">–°–û–ó–î–ê–¢–¨</button>
            <button class="btn-join" onclick="joinRoom()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="roomDisplay" style="text-align:center; font-weight:bold; color:#fdbb2d; margin-bottom:10px;"></div>
    <button class="btn-start" id="startBtn" style="display:none;" onclick="requestStart()">–ó–ê–ü–£–°–¢–ò–¢–¨ –ú–û–¢–û–†–´ üöÄ</button>

    <div id="countdown" style="font-size: 60px; text-align: center; color: #fdbb2d; height: 70px; font-weight: bold;"></div>

    <div class="game-card">
        <div id="textDisplay" class="text-display">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
        <input type="text" id="typingInput" placeholder="–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..." disabled
               autocorrect="off" autocapitalize="off" spellcheck="false">

        <div class="stats-bar">
            <div class="stat-box"><span class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</span><span id="wpm" class="stat-val">0</span></div>
            <div class="stat-box"><span class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</span><span id="acc" class="stat-val">100%</span></div>
            <div class="stat-box"><span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="progress" class="stat-val">0%</span></div>
        </div>
    </div>

    <div id="playersList"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7",
        measurementId: "G-EP6VX4V6ET"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = {
        roomID: null, playerName: '', text: '',
        pos: 0, errors: 0, totalTyped: 0,
        startTime: null, isRacing: false, isHost: false
    };

    const texts = [
        "–¢—Ä—É–¥–Ω–æ –Ω–µ –∑–Ω–∞—á–∏—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç–µ–±–µ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–æ—Ç—Ä—É–¥–∏—Ç—å—Å—è.",
        "–ö–∞–∂–¥–∞—è –≤–µ–ª–∏–∫–∞—è –º–µ—á—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –º–µ—á—Ç–∞—Ç–µ–ª—è. –í—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏ –æ–± —ç—Ç–æ–º.",
        "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç ‚Äî —ç—Ç–æ –º–∞—à–∏–Ω–∞ –ø–æ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—é –∫–æ—Ñ–µ –≤ –∫–æ–¥.",
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É—Ç–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º. –ù—É–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Ü–µ–ª–∏."
    ];

    async function createRoom() {
        const name = document.getElementById('playerName').value.trim();
        if(!name) return;
        state.roomID = Math.random().toString(36).substring(2, 6).toUpperCase();
        state.playerName = name;
        state.isHost = true;
        state.text = texts[Math.floor(Math.random() * texts.length)];

        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('lobby').style.display = 'none';

        await db.ref('rooms/' + state.roomID).set({
            text: state.text, status: 'waiting',
            players: { [name]: { pos: 0, wpm: 0, finished: false } }
        });
        listenToRoom(state.roomID);
    }

    async function joinRoom() {
        const roomID = document.getElementById('roomCode').value.trim().toUpperCase();
        const name = document.getElementById('playerName').value.trim();
        if(!roomID || !name) return;

        const snap = await db.ref('rooms/' + roomID).once('value');
        if(!snap.exists()) return alert("–ù–µ—Ç —Ç–∞–∫–æ–π –∫–æ–º–Ω–∞—Ç—ã!");

        state.roomID = roomID;
        state.playerName = name;
        state.text = snap.val().text;
        document.getElementById('lobby').style.display = 'none';

        await db.ref(`rooms/${roomID}/players/${name}`).update({ pos: 0, wpm: 0 });
        listenToRoom(roomID);
    }

    function listenToRoom(roomID) {
        document.getElementById('roomDisplay').innerText = "ID –ì–û–ù–ö–ò: " + roomID;
        db.ref('rooms/' + roomID).on('value', (snap) => {
            const data = snap.val();
            if(!data) return;
            updateUI(data);
            if(data.status === 'starting' && !state.counting) startLocalCountdown();
            if(data.status === 'racing' && !state.isRacing) startRace();
        });
    }

    function requestStart() { db.ref(`rooms/${state.roomID}/status`).set('starting'); }

    function startLocalCountdown() {
        state.counting = true;
        let c = 3;
        const t = setInterval(() => {
            document.getElementById('countdown').innerText = c > 0 ? c : 'üèÅ';
            c--;
            if(c < -1) {
                clearInterval(t);
                document.getElementById('countdown').innerText = '';
                if(state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true;
        state.startTime = Date.now();
        const inp = document.getElementById('typingInput');
        inp.disabled = false;
        inp.focus();
    }

    function updateUI(data) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for(let n in data.players) {
            const p = data.players[n];
            const perc = (p.pos / state.text.length) * 100;
            list.innerHTML += `
                <div class="game-card" style="margin-bottom:10px">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px">
                        <span>${n}</span><span>${p.wpm} WPM</span>
                    </div>
                    <div class="race-track"><div class="race-car" style="left:${perc}%">üèéÔ∏è</div></div>
                </div>`;
        }
        renderText();
    }

    function renderText() {
        const display = document.getElementById('textDisplay');
        const typed = document.getElementById('typingInput').value;
        let html = "";

        for(let i = 0; i < state.text.length; i++) {
            let char = state.text[i];
            let cls = "";
            if(i < state.pos) cls = "correct";
            else if(i === state.pos) {
                cls = "current-char";
                if(typed.length > 0 && typed[0] !== char) cls += " wrong";
            }
            html += `<span class="${cls}">${char === ' ' ? '&nbsp;' : char}</span>`;
        }
        display.innerHTML = html;
    }

    document.getElementById('typingInput').addEventListener('input', (e) => {
        if(!state.isRacing) return;
        const val = e.target.value;
        if(val.length === 0) { renderText(); return; }

        state.totalTyped++;
        const expected = state.text[state.pos];
        const actual = val[0];

        if(actual === expected) {
            state.pos++;
            e.target.value = '';

            const minutes = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round((state.pos / 5) / minutes);
            const accuracy = Math.round(((state.totalTyped - state.errors) / state.totalTyped) * 100);

            document.getElementById('wpm').innerText = wpm;
            document.getElementById('acc').innerText = accuracy + '%';
            document.getElementById('progress').innerText = Math.round((state.pos / state.text.length) * 100) + '%';

            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({
                pos: state.pos, wpm: wpm
            });

            if(state.pos === state.text.length) finish();
        } else {
            state.errors++;
            renderText();
        }
    });

    function finish() {
        state.isRacing = false;
        document.getElementById('typingInput').disabled = true;
        const finalAcc = Math.round(((state.totalTyped - state.errors) / state.totalTyped) * 100);
        alert(`–ì–æ–Ω–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à–∞ —Ç–æ—á–Ω–æ—Å—Ç—å: ${finalAcc}%`);
    }
</script>
</body>
</html>