<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpeedRacer | Ultimate Type Experience</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #fdbb2d;
            --success: #22c55e;
            --bg: #050510;
            --card-bg: rgba(20, 20, 35, 0.95);
            --border: rgba(0, 242, 255, 0.2);
            --text-muted: #808090;
            --error: #ff4e50;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            outline: none;
        }
        
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: #050510;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at 20% 50%, rgba(112, 0, 255, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 242, 255, 0.15), transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(253, 187, 45, 0.1), transparent 50%);
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
            opacity: 0.3;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-100px) translateX(50px); }
            50% { transform: translateY(-200px) translateX(-50px); }
            75% { transform: translateY(-100px) translateX(100px); }
        }

        .container { 
            width: 100%; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px 20px;
            position: relative;
            z-index: 10;
        }

        .game-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 60px rgba(0, 242, 255, 0.1),
                        0 0 100px rgba(112, 0, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 70px rgba(0, 242, 255, 0.15),
                        0 0 120px rgba(112, 0, 255, 0.08);
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            animation: gradientFlow 3s ease infinite;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .glow-text {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 3.5rem;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease infinite;
            text-shadow: 0 0 40px rgba(0, 242, 255, 0.5);
            margin-bottom: 20px;
        }

        .text-display {
            font-size: 2.2rem;
            line-height: 2.2;
            font-family: 'Inter', monospace;
            color: var(--text-muted);
            margin-bottom: 30px;
            letter-spacing: 1px;
            padding: 35px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .text-display span {
            display: inline-block;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .correct { 
            color: var(--success);
            text-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
            transform: scale(1.1);
        }

        .current {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000;
            border-radius: 6px;
            padding: 4px 8px;
            box-shadow: 0 0 25px var(--primary);
            animation: pulse 1s infinite, bounce 0.6s ease-in-out infinite;
            transform: scale(1.2);
        }

        .error-char {
            color: var(--error);
            text-decoration: underline wavy;
            text-underline-offset: 5px;
            animation: shake 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 25px var(--primary); }
            50% { opacity: 0.8; box-shadow: 0 0 40px var(--primary); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1.2) translateY(0); }
            50% { transform: scale(1.2) translateY(-3px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px) rotate(-2deg); }
            75% { transform: translateX(8px) rotate(2deg); }
        }

        #typingInput {
            width: 100%;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            font-family: 'Inter', monospace;
            text-align: center;
        }

        #typingInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.3),
                        inset 0 0 20px rgba(0, 242, 255, 0.1);
            transform: scale(1.02);
        }

        #typingInput.error {
            border-color: var(--error);
            animation: shake 0.4s;
            box-shadow: 0 0 30px rgba(255, 78, 80, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(112, 0, 255, 0.1));
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-item:hover::before {
            left: 100%;
        }

        .stat-val {
            display: block;
            font-weight: 900;
            font-family: 'Orbitron', monospace;
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 8px;
            text-shadow: 0 0 20px var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .track {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            margin: 50px 0 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: trackShine 2s linear infinite;
        }

        @keyframes trackShine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .car {
            position: absolute;
            top: -45px;
            font-size: 35px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 15px var(--primary)) 
                    drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
            animation: carBounce 0.8s ease-in-out infinite;
        }

        @keyframes carBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .btn {
            padding: 18px 40px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
            font-size: 1rem;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--error));
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: #000;
        }

        #countdown {
            font-size: 8rem;
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: countdownPulse 1s ease-in-out infinite;
            text-shadow: 0 0 60px var(--primary);
        }

        @keyframes countdownPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .lobby-input {
            width: 100%;
            padding: 18px 25px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.1rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .lobby-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            transform: scale(1.02);
        }

        .share-link {
            background: rgba(0, 242, 255, 0.15);
            padding: 15px 25px;
            border-radius: 100px;
            border: 2px solid var(--primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .share-link:hover {
            background: rgba(0, 242, 255, 0.25);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
        }

        .copy-notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000;
            padding: 20px 30px;
            border-radius: 16px;
            font-weight: 700;
            animation: slideIn 0.4s ease-out, fadeOut 0.4s 1.6s;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 242, 255, 0.5);
            font-size: 1.1rem;
        }

        @keyframes slideIn {
            from { transform: translateX(500px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        .user-info {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border);
            padding: 12px 25px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 242, 255, 0.2);
        }

        .user-name {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.05rem;
        }

        .logout-btn, .admin-btn {
            background: rgba(255, 78, 80, 0.15);
            color: var(--error);
            border: 2px solid var(--error);
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.3s;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .admin-btn {
            background: rgba(253, 187, 45, 0.15);
            color: var(--accent);
            border-color: var(--accent);
        }

        .logout-btn:hover {
            background: var(--error);
            color: #000;
            transform: scale(1.1);
        }

        .admin-btn:hover {
            background: var(--accent);
            color: #000;
            transform: scale(1.1);
        }

        .achievement {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            padding: 20px 30px;
            border-radius: 16px;
            color: #000;
            font-weight: 700;
            animation: achievementPop 0.5s ease-out;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(253, 187, 45, 0.6);
        }

        @keyframes achievementPop {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px var(--primary);
        }

        .player-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .player-card:hover {
            transform: translateX(10px);
            border-color: var(--primary);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.3);
        }

        .language-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .lang-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lang-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
        }

        .restart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .restart-content {
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 24px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 242, 255, 0.3);
        }

        .restart-timer {
            font-size: 5rem;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .glow-text { font-size: 2rem; }
            .text-display { font-size: 1.6rem; padding: 20px; }
            #typingInput { font-size: 1.2rem; }
            .stat-val { font-size: 1.8rem; }
            #countdown { font-size: 5rem; }
            .restart-timer { font-size: 3rem; }
        }

        .finish-celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>

<div class="bg-animation"></div>
<div class="particles" id="particles"></div>

<div class="user-info">
    <span class="user-name" id="userName">üë§ –ì–æ—Å—Ç—å</span>
    <a href="panel.html" class="admin-btn" id="adminBtn" style="display: none;">üëë –ê–¥–º–∏–Ω</a>
    <button class="logout-btn" onclick="logout()">–í—ã—Ö–æ–¥</button>
</div>

<div class="container">
    <div id="lobby" class="game-card" style="max-width: 550px; margin: 80px auto;">
        <h1 class="glow-text">üèéÔ∏è SPEEDRACER</h1>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 30px; font-size: 1.1rem;">
            –¢—Ä–µ–Ω–∏—Ä—É–π —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –≤ —Å—Ç–∏–ª–µ –∫–∏–±–µ—Ä–ø–∞–Ω–∫!
        </p>

        <div class="language-selector">
            <button class="lang-btn active" onclick="selectLanguage('ru')" data-lang="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="lang-btn" onclick="selectLanguage('en')" data-lang="en">üá¨üáß English</button>
            <button class="lang-btn" onclick="selectLanguage('es')" data-lang="es">üá™üá∏ Espa√±ol</button>
            <button class="lang-btn" onclick="selectLanguage('fr')" data-lang="fr">üá´üá∑ Fran√ßais</button>
            <button class="lang-btn" onclick="selectLanguage('de')" data-lang="de">üá©üá™ Deutsch</button>
        </div>
        
        <input type="text" id="playerName" class="lobby-input" placeholder="üë§ –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è" maxlength="20">
        <input type="text" id="roomCode" class="lobby-input" placeholder="üîê –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" maxlength="6">

        <div style="display:grid; grid-template-columns: 1fr; gap:15px;">
            <button class="btn btn-primary" onclick="createRoom()">üåê –°–û–ó–î–ê–¢–¨ –û–ù–õ–ê–ô–ù –ì–û–ù–ö–£</button>
            <button class="btn btn-secondary" onclick="joinRoom()">üîó –í–û–ô–¢–ò –ü–û –ö–û–î–£</button>
            <button class="btn btn-success" onclick="startSolo()">‚ö° –û–î–ò–ù–û–ß–ù–ê–Ø –ü–†–ê–ö–¢–ò–ö–ê</button>
        </div>
    </div>

    <div id="gameView" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap: wrap; gap: 15px;">
            <div id="shareBox" class="share-link" onclick="copyLink()">
                <span id="roomInfo" style="font-weight: 800;">–ö–û–î: ...</span>
                <span>üìã –ö–û–ü–ò–†–û–í–ê–¢–¨</span>
            </div>
            <button class="btn logout-btn" onclick="exitRoom()">‚Üê –í–´–•–û–î</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="globalProgress" style="width: 0%"></div>
        </div>

        <div id="countdown"></div>
        <div id="restartTimer" style="text-align: center; color: var(--accent); margin-bottom: 15px; font-size: 1.3rem; font-weight: 700;"></div>

        <button id="startBtn" class="btn btn-primary" style="display:none; width: 100%; margin-bottom: 30px; font-size: 1.2rem;" onclick="requestStart()">
            üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –ì–û–ù–ö–£
        </button>

        <div class="game-card">
            <div id="textDisplay" class="text-display">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Å—Å—ã...</div>
            <input type="text" id="typingInput" placeholder="–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è –ø–µ—á–∞—Ç–∞—Ç—å..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled>

            <div class="stats-grid">
                <div class="stat-item">
                    <span id="wpm" class="stat-val">0</span>
                    <span class="stat-label">üí® WPM</span>
                </div>
                <div class="stat-item">
                    <span id="timer" class="stat-val">00:00</span>
                    <span class="stat-label">‚è±Ô∏è –í–†–ï–ú–Ø</span>
                </div>
                <div class="stat-item">
                    <span id="acc" class="stat-val">100%</span>
                    <span class="stat-label">üéØ –¢–û–ß–ù–û–°–¢–¨</span>
                </div>
                <div class="stat-item">
                    <span id="progress" class="stat-val">0%</span>
                    <span class="stat-label">üìä –ü–†–û–ì–†–ï–°–°</span>
                </div>
            </div>
        </div>
        
        <div id="playersList" style="margin-top: 30px;"></div>
    </div>
</div>

<div class="finish-celebration" id="celebration"></div>

<div class="restart-modal" id="restartModal">
    <div class="restart-content">
        <h2 style="font-size: 2.5rem; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üèÅ –ì–æ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
        </h2>
        <div id="finalStats" style="margin: 20px 0; color: var(--text-muted);"></div>
        <div class="restart-timer" id="restartCountdown">30</div>
        <p style="color: var(--text-muted); margin-bottom: 30px;">–°–ª–µ–¥—É—é—â–∞—è –≥–æ–Ω–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
        <button class="btn btn-primary" onclick="manualRestart()" style="font-size: 1.2rem; padding: 20px 50px;">
            üöÄ –ù–ê–ß–ê–¢–¨ –°–ï–ô–ß–ê–°
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCX5cv94WSVGJfX9Vddgxrqgg9CEH_QgvA",
        authDomain: "prince-10014.firebaseapp.com",
        databaseURL: "https://prince-10014-default-rtdb.firebaseio.com",
        projectId: "prince-10014",
        storageBucket: "prince-10014.firebasestorage.app",
        messagingSenderId: "900737897462",
        appId: "1:900737897462:web:a29a4d2c8cada3a3f36dd7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è —Ñ–æ–Ω–∞
    function createParticles() {
        const particles = document.getElementById('particles');
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 8 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 5) + 's';
            particles.appendChild(particle);
        }
    }
    createParticles();

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 's' || e.key === 'i')) {
            e.preventDefault();
        }
        if (e.key === 'F12') {
            e.preventDefault();
        }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const savedUser = localStorage.getItem('speedracer_user');
    if (!savedUser) {
        window.location.href = 'login.html';
    } else {
        const userData = JSON.parse(savedUser);
        document.getElementById('userName').textContent = 'üë§ ' + userData.username;
        document.getElementById('playerName').value = userData.username;
        
        if (userData.isAdmin) {
            document.getElementById('adminBtn').style.display = 'inline-block';
        }

        db.ref(`simple_users/${userData.userId}`).update({
            lastActivity: Date.now()
        });
    }

    function logout() {
        localStorage.removeItem('speedracer_user');
        window.location.href = 'login.html';
    }

    const phrasesByLanguage = {
        ru: [
            "–°–∫–æ—Ä–æ—Å—Ç—å –∏ —Ç–æ—á–Ω–æ—Å—Ç—å ‚Äî –≤–æ—Ç —Å–µ–∫—Ä–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã",
            "–ö–∞–∂–¥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤—É",
            "–ü–æ–±–µ–∂–¥–∞–µ—Ç –Ω–µ —Ç–æ—Ç –∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ, –∞ —Ç–æ—Ç –∫—Ç–æ —É–º–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ –ø–∞–ª—å—Ü—ã",
            "–ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–º, –∞ –∏–¥–µ–∞–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç –ª–µ–≥–µ–Ω–¥–æ–π",
            "–¢–≤–æ–∏ —Ä—É–∫–∏ ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç–≤–æ–π —Ä–∞–∑—É–º ‚Äî —ç—Ç–æ –¥–≤–∏–≥–∞—Ç–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞",
            "–í–µ–ª–∏–∫–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ –≤–ø–µ—Ä–µ–¥",
            "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–¥, –Ω–æ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç–≤–æ–µ–≥–æ –º—ã—à–ª–µ–Ω–∏—è",
            "–ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è —É—á–∏—Ç—å—Å—è –∏ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è",
            "–ö–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ —ç—Ç–æ —É—Ä–æ–∫, –∫–∞–∂–¥—ã–π —É—Å–ø–µ—Ö —ç—Ç–æ —à–∞–≥ –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É",
            "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –º–µ–Ω—è—é—Ç –º–∏—Ä, –Ω–æ —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –º–µ–Ω—è—é—Ç —Ç–≤–æ—é —Å—É–¥—å–±—É",
            "–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞–º–∏, –Ω–æ –∏ —Ç–≤–æ–µ–π —Ä–µ—à–∏–º–æ—Å—Ç—å—é",
            "–í –º–∏—Ä–µ –≥–¥–µ –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è, —Ç–≤–æ—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –æ—Å—Ç–∞—ë—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π",
            "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–≤–æ–∏—Ö –º—ã—Å–ª–µ–π, –Ω–∞—É—á–∏—Å—å –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –µ—ë —è–∑—ã–∫–µ",
            "–í—Ä–µ–º—è —Å–∞–º—ã–π —Ü–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—è –Ω–∞–≤—ã–∫–∏",
            "–¶–∏—Ñ—Ä–æ–≤–æ–π –≤–µ–∫ —Ç—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä—ã—Ö —Ä—É–∫ –∏ –µ—â—ë –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ —É–º–∞"
        ],
        en: [
            "Speed and accuracy are the secrets of a true keyboard master",
            "Every keystroke brings you closer to perfection and excellence",
            "The winner is not the fastest, but the smartest finger dancer",
            "Practice makes perfect, and perfect practice makes legends",
            "Your hands are tools, your mind is the engine of progress",
            "Great achievements begin with small consistent steps forward",
            "Programming is not just code, but the speed of your thinking",
            "The future belongs to those who dare to learn and improve",
            "Every mistake is a lesson, every success is a step to mastery",
            "Technology changes the world, but your skills change your destiny",
            "Typing speed is measured not only in words, but in determination",
            "In a world where everything is automated, your speed remains unique",
            "The keyboard is an extension of your thoughts, learn its language",
            "Time is the most valuable resource, use it wisely developing skills",
            "The digital age requires fast hands and even faster minds"
        ],
        es: [
            "La velocidad y la precisi√≥n son los secretos de un maestro del teclado",
            "Cada pulsaci√≥n te acerca a la perfecci√≥n y la excelencia",
            "El ganador no es el m√°s r√°pido, sino el bailar√≠n de dedos m√°s inteligente",
            "La pr√°ctica hace la perfecci√≥n, y la pr√°ctica perfecta hace leyendas",
            "Tus manos son herramientas, tu mente es el motor del progreso",
            "Los grandes logros comienzan con peque√±os pasos consistentes hacia adelante",
            "La programaci√≥n no es solo c√≥digo, sino la velocidad de tu pensamiento",
            "El futuro pertenece a aquellos que se atreven a aprender y mejorar",
            "Cada error es una lecci√≥n, cada √©xito es un paso hacia la maestr√≠a",
            "La tecnolog√≠a cambia el mundo, pero tus habilidades cambian tu destino",
            "La velocidad de escritura se mide no solo en palabras, sino en determinaci√≥n",
            "En un mundo donde todo est√° automatizado, tu velocidad sigue siendo √∫nica",
            "El teclado es una extensi√≥n de tus pensamientos, aprende su idioma",
            "El tiempo es el recurso m√°s valioso, √∫salo sabiamente desarrollando habilidades",
            "La era digital requiere manos r√°pidas y mentes a√∫n m√°s r√°pidas"
        ],
        fr: [
            "La vitesse et la pr√©cision sont les secrets d'un v√©ritable ma√Ætre du clavier",
            "Chaque frappe vous rapproche de la perfection et de l'excellence",
            "Le gagnant n'est pas le plus rapide, mais le danseur de doigts le plus intelligent",
            "La pratique rend parfait, et la pratique parfaite cr√©e des l√©gendes",
            "Vos mains sont des outils, votre esprit est le moteur du progr√®s",
            "Les grandes r√©alisations commencent par de petits pas coh√©rents en avant",
            "La programmation n'est pas seulement du code, mais la vitesse de votre pens√©e",
            "L'avenir appartient √† ceux qui osent apprendre et s'am√©liorer",
            "Chaque erreur est une le√ßon, chaque succ√®s est un pas vers la ma√Ætrise",
            "La technologie change le monde, mais vos comp√©tences changent votre destin",
            "La vitesse de frappe se mesure non seulement en mots, mais en d√©termination",
            "Dans un monde o√π tout est automatis√©, votre vitesse reste unique",
            "Le clavier est une extension de vos pens√©es, apprenez son langage",
            "Le temps est la ressource la plus pr√©cieuse, utilisez-le judicieusement",
            "L'√®re num√©rique n√©cessite des mains rapides et des esprits encore plus rapides"
        ],
        de: [
            "Geschwindigkeit und Genauigkeit sind die Geheimnisse eines wahren Tastaturmeisters",
            "Jeder Tastendruck bringt Sie n√§her zur Perfektion und Exzellenz",
            "Der Gewinner ist nicht der Schnellste, sondern der kl√ºgste Fingert√§nzer",
            "√úbung macht den Meister, und perfekte √úbung macht Legenden",
            "Ihre H√§nde sind Werkzeuge, Ihr Verstand ist der Motor des Fortschritts",
            "Gro√üe Erfolge beginnen mit kleinen konsistenten Schritten nach vorne",
            "Programmieren ist nicht nur Code, sondern die Geschwindigkeit Ihres Denkens",
            "Die Zukunft geh√∂rt denen, die es wagen zu lernen und sich zu verbessern",
            "Jeder Fehler ist eine Lektion, jeder Erfolg ist ein Schritt zur Meisterschaft",
            "Technologie ver√§ndert die Welt, aber Ihre F√§higkeiten ver√§ndern Ihr Schicksal",
            "Tippgeschwindigkeit wird nicht nur in Worten gemessen, sondern in Entschlossenheit",
            "In einer Welt, in der alles automatisiert ist, bleibt Ihre Geschwindigkeit einzigartig",
            "Die Tastatur ist eine Erweiterung Ihrer Gedanken, lernen Sie ihre Sprache",
            "Zeit ist die wertvollste Ressource, nutzen Sie sie weise zur Entwicklung",
            "Das digitale Zeitalter erfordert schnelle H√§nde und noch schnellere K√∂pfe"
        ]
    };

    let selectedLanguage = 'ru';

    let state = {
        roomID: null, playerName: '', text: '',
        pos: 0, startTime: null, isRacing: false, isHost: false,
        timerInterval: null, restarting: false, isSolo: false,
        errors: 0, totalChars: 0, lastInputLength: 0,
        restartTimerInterval: null
    };

    function selectLanguage(lang) {
        selectedLanguage = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
        showNotification(`üåç –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω: ${document.querySelector(`[data-lang="${lang}"]`).textContent}`);
    }

    function getRandomPhrase() {
        const phrases = phrasesByLanguage[selectedLanguage];
        return phrases[Math.floor(Math.random() * phrases.length)];
    }

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const rCode = urlParams.get('room');
        if (rCode) {
            document.getElementById('roomCode').value = rCode.toUpperCase();
        }
    };

    function showNotification(text) {
        const notif = document.createElement('div');
        notif.className = 'copy-notification';
        notif.textContent = text;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 2000);
    }

    function showAchievement(text) {
        const achievement = document.createElement('div');
        achievement.className = 'achievement';
        achievement.innerHTML = `üèÜ ${text}`;
        document.body.appendChild(achievement);
        setTimeout(() => achievement.remove(), 3000);
    }

    function createConfetti() {
        const celebration = document.getElementById('celebration');
        const colors = ['#00f2ff', '#7000ff', '#fdbb2d', '#22c55e', '#ff4e50'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                celebration.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }, i * 30);
        }
    }

    function copyLink() {
        const link = window.location.origin + window.location.pathname + "?room=" + state.roomID;
        navigator.clipboard.writeText(link).then(() => {
            showNotification('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    }

    function initView() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameView').style.display = 'block';
        document.getElementById('roomInfo').innerText = "–ö–û–î: " + state.roomID;
        if (state.isHost || state.isSolo) document.getElementById('startBtn').style.display = 'block';

        const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + state.roomID;
        window.history.pushState({path:newurl},'',newurl);
    }

    async function createRoom() {
        const n = document.getElementById('playerName').value.trim() || "–ì–æ–Ω—â–∏–∫";
        const r = Math.random().toString(36).substring(2, 6).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: false};
        await db.ref('rooms/' + r).set({
            text: getRandomPhrase(),
            language: selectedLanguage,
            status: 'waiting', players: {[n]: {pos: 0, wpm: 0, finished: false}}
        });
        initView();
        listen(r);
        showNotification('üéÆ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–¥–µ–ª–∏—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏!');
    }

    async function startSolo() {
        const n = document.getElementById('playerName').value.trim() || "–°–æ–ª–æ";
        const r = "SOLO-" + Math.random().toString(36).substring(2, 5).toUpperCase();
        state = {...state, roomID: r, playerName: n, isHost: true, isSolo: true};
        state.text = getRandomPhrase();
        initView();
        document.getElementById('shareBox').style.display = 'none';
        renderPlayers({[n]: {pos: 0, wpm: 0, finished: false}});
        showNotification('‚ö° –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!');
    }

    async function joinRoom() {
        const r = document.getElementById('roomCode').value.trim().toUpperCase();
        const n = document.getElementById('playerName').value.trim() || "–£—á–∞—Å—Ç–Ω–∏–∫";
        if (!r) {
            showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
            return;
        }
        const snap = await db.ref(`rooms/${r}`).once('value');
        if (!snap.exists()) {
            showNotification('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            return;
        }
        state = {...state, roomID: r, playerName: n, isHost: false, isSolo: false};
        await db.ref(`rooms/${r}/players/${n}`).update({pos: 0, wpm: 0, finished: false});
        initView();
        listen(r);
        showNotification('‚úì –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥–æ–Ω–∫–µ!');
    }

    function exitRoom() {
        if (state.roomID && !state.isSolo) {
            db.ref(`rooms/${state.roomID}/players/${state.playerName}`).remove();
        }
        window.location.href = window.location.pathname;
    }

    function listen(r) {
        if (state.isSolo) return;
        db.ref('rooms/' + r).on('value', snap => {
            const d = snap.val();
            if (!d) return;
            state.text = d.text;
            if (d.language) selectedLanguage = d.language;
            renderPlayers(d.players);
            if (d.status === 'starting' && !state.counting) startCountdown();
            if (d.status === 'racing' && !state.isRacing) startRace();

            const pArray = Object.values(d.players);
            if (pArray.every(p => p.finished) && d.status === 'racing' && !state.restarting) {
                startAutoRestart();
            }
        });
    }

    function requestStart() {
        if (state.isSolo) startCountdown();
        else db.ref(`rooms/${state.roomID}/status`).set('starting');
    }

    function startCountdown() {
        state.counting = true;
        document.getElementById('startBtn').style.display = 'none';
        let c = 3;
        const countdownEl = document.getElementById('countdown');
        
        const t = setInterval(() => {
            countdownEl.innerText = c > 0 ? c : 'üöÄ –ì–û!';
            if (c === 0) {
                showNotification('üèÅ –°–¢–ê–†–¢!');
            }
            c--;
            if (c < -1) {
                clearInterval(t);
                countdownEl.innerText = '';
                if (state.isSolo) startRace();
                else if (state.isHost) db.ref(`rooms/${state.roomID}/status`).set('racing');
                state.counting = false;
            }
        }, 1000);
    }

    function startRace() {
        state.isRacing = true;
        state.restarting = false;
        state.startTime = Date.now();
        state.pos = 0;
        state.errors = 0;
        state.totalChars = 0;
        state.lastInputLength = 0;

        const inp = document.getElementById('typingInput');
        inp.disabled = false;
        inp.value = "";
        inp.classList.remove('error');
        inp.placeholder = "–ü–µ—á–∞—Ç–∞–π –∑–¥–µ—Å—å...";
        inp.focus();

        state.timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - state.startTime) / 1000);
            document.getElementById('timer').innerText = `${Math.floor(diff / 60).toString().padStart(2, '0')}:${(diff % 60).toString().padStart(2, '0')}`;
        }, 1000);
    }

    function startAutoRestart() {
        state.restarting = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        const modal = document.getElementById('restartModal');
        modal.style.display = 'flex';
        
        const elapsed = (Date.now() - state.startTime) / 1000;
        const wpm = Math.round((state.pos / 5) / (elapsed / 60)) || 0;
        const acc = state.totalChars > 0 ? Math.round(((state.totalChars - state.errors) / state.totalChars) * 100) : 100;
        
        document.getElementById('finalStats').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="padding: 15px; background: rgba(0, 242, 255, 0.1); border-radius: 12px;">
                    <div style="font-size: 2rem; color: var(--primary); font-weight: 800;">${wpm}</div>
                    <div style="font-size: 0.9rem;">WPM</div>
                </div>
                <div style="padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 12px;">
                    <div style="font-size: 2rem; color: var(--success); font-weight: 800;">${acc}%</div>
                    <div style="font-size: 0.9rem;">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                </div>
            </div>
        `;
        
        let timeLeft = 30;
        document.getElementById('restartCountdown').innerText = timeLeft;
        
        if (state.restartTimerInterval) {
            clearInterval(state.restartTimerInterval);
        }
        
        state.restartTimerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('restartCountdown').innerText = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(state.restartTimerInterval);
                manualRestart();
            }
        }, 1000);
    }

    function manualRestart() {
        if (state.restartTimerInterval) {
            clearInterval(state.restartTimerInterval);
        }
        
        document.getElementById('restartModal').style.display = 'none';
        document.getElementById('restartTimer').innerText = '';
        
        if (state.isSolo) {
            state.text = getRandomPhrase();
            renderPlayers({[state.playerName]: {pos: 0, wpm: 0, finished: false}});
            startCountdown();
        } else if (state.isHost) {
            db.ref(`rooms/${state.roomID}`).update({
                status: 'starting',
                text: getRandomPhrase(),
                language: selectedLanguage
            });
            db.ref(`rooms/${state.roomID}/players`).once('value', s => {
                const players = s.val();
                for (let p in players) {
                    db.ref(`rooms/${state.roomID}/players/${p}`).update({pos: 0, wpm: 0, finished: false});
                }
            });
        }
    }

    function renderPlayers(players) {
        const list = document.getElementById('playersList');
        list.innerHTML = '';
        for (let n in players) {
            const p = players[n];
            const perc = state.text.length > 0 ? (p.pos / state.text.length) * 100 : 0;
            const statusEmoji = p.finished ? 'üèÅ' : 'üèéÔ∏è';
            const isYou = n === state.playerName;
            
            list.innerHTML += `
                <div class="player-card" style="${isYou ? 'border-color: var(--primary); box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);' : ''}">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom: 12px;">
                        <span style="font-weight: 700; color: ${isYou ? 'var(--primary)' : '#fff'};">
                            ${n} ${isYou ? '(–í–´)' : ''}
                        </span>
                        <span style="color: var(--accent); font-weight: 700; font-size: 16px;">${p.wpm} WPM</span>
                    </div>
                    <div class="track">
                        <div class="car" style="left:${perc}%">${statusEmoji}</div>
                    </div>
                </div>`;
        }
        updateDisplayText();
    }

    function updateDisplayText() {
        const d = document.getElementById('textDisplay');
        let h = "";
        for (let i = 0; i < state.text.length; i++) {
            let cls = i < state.pos ? "correct" : (i === state.pos ? "current" : "");
            h += `<span class="${cls}">${state.text[i]}</span>`;
        }
        d.innerHTML = h;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const globalProgress = (state.pos / state.text.length) * 100;
        document.getElementById('globalProgress').style.width = globalProgress + '%';
    }

    const typingInput = document.getElementById('typingInput');

    typingInput.addEventListener('paste', e => {
        e.preventDefault();
        typingInput.classList.add('error');
        setTimeout(() => typingInput.classList.remove('error'), 300);
        showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞! –ü–µ—á–∞—Ç–∞–π —Å–∞–º!');
    });

    typingInput.addEventListener('contextmenu', e => e.preventDefault());

    typingInput.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
            e.preventDefault();
            showNotification('‚ùå –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞!');
        }
    });

    typingInput.addEventListener('input', e => {
        if (!state.isRacing) return;

        const inp = e.target;
        const val = inp.value;

        const lengthDiff = val.length - state.lastInputLength;
        if (lengthDiff > 1 || e.inputType === 'insertFromPaste') {
            inp.value = "";
            state.lastInputLength = 0;
            inp.classList.add('error');
            setTimeout(() => inp.classList.remove('error'), 300);
            showNotification('‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ —á–∏—Ç–µ—Ä—Å—Ç–≤–∞!');
            return;
        }

        state.lastInputLength = val.length;
        const expectedNextChar = state.text[state.pos];

        if (val === expectedNextChar) {
            state.pos++;
            state.totalChars++;
            inp.value = "";
            state.lastInputLength = 0;
            inp.classList.remove('error');

            const elapsed = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round((state.pos / 5) / elapsed) || 0;
            const acc = state.totalChars > 0 ? Math.round(((state.totalChars - state.errors) / state.totalChars) * 100) : 100;

            document.getElementById('wpm').innerText = wpm;
            document.getElementById('acc').innerText = acc + '%';
            document.getElementById('progress').innerText = Math.round((state.pos / state.text.length) * 100) + '%';

            // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            if (wpm >= 100 && !state.achievement100) {
                showAchievement('–°–∫–æ—Ä–æ—Å—Ç—å 100+ WPM!');
                state.achievement100 = true;
            }
            if (acc === 100 && state.pos > 50 && !state.achievementPerfect) {
                showAchievement('–ò–¥–µ–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å!');
                state.achievementPerfect = true;
            }

            const isFin = state.pos === state.text.length;

            if (!state.isSolo) {
                db.ref(`rooms/${state.roomID}/players/${state.playerName}`).update({
                    pos: state.pos, wpm: wpm, finished: isFin
                });
            } else {
                renderPlayers({[state.playerName]: {pos: state.pos, wpm: wpm, finished: isFin}});
            }

            if (isFin) {
                state.isRacing = false;
                clearInterval(state.timerInterval);
                inp.disabled = true;
                createConfetti();
                showNotification(`üèÜ –§–ò–ù–ò–®! ${wpm} WPM | –¢–æ—á–Ω–æ—Å—Ç—å: ${acc}%`);
                if (wpm > 80) {
                    showAchievement('–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!');
                }
            }
        } else if (val.length > 0) {
            state.errors++;
            state.totalChars++;
            inp.classList.add('error');
            setTimeout(() => inp.classList.remove('error'), 200);
        }

        updateDisplayText();
    });
</script>
</body>
</html>
